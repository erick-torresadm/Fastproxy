<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://js.stripe.com https://cdnjs.cloudflare.com 'unsafe-inline'; connect-src 'self' http://localhost:8080 https://api.stripe.com https://*.stripe.com; frame-src 'self' https://js.stripe.com https://checkout.stripe.com https://*.stripe.com; img-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;">
    <title>FastProxy - Checkout com Stripe</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #1e88e5;
            margin-bottom: 20px;
        }
        
        .card {
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            margin-bottom: 20px;
        }
        
        .price-display {
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            margin: 20px 0;
            color: #1e88e5;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .quantity-btn {
            background-color: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #quantity {
            width: 60px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 0 10px;
            font-size: 16px;
            padding: 8px;
        }
        
        .plan-types {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .plan-type-btn {
            background-color: #fff;
            border: 2px solid #ddd;
            padding: 10px 25px;
            margin: 0 5px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .plan-type-btn.active {
            background-color: #1e88e5;
            border-color: #1e88e5;
            color: white;
        }
        
        .checkout-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #1e88e5;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: #1976d2;
        }
        
        .checkout-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .discount-info {
            text-align: center;
            color: #43a047;
            margin: 10px 0;
        }
        
        .error-message {
            color: #d32f2f;
            text-align: center;
            margin: 10px 0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <div class="container">
        <h1>FastProxy - Checkout</h1>
        
        <div class="plan-types">
            <button class="plan-type-btn active" data-plan="monthly">Mensal</button>
            <button class="plan-type-btn" data-plan="yearly">Anual</button>
        </div>
        
        <div class="card">
            <h3>Proxy IPv6 de Alta Performance</h3>
            <p>Ideal para uso em redes sociais e múltiplas contas</p>
            
            <div class="price-display">
                <span id="unit-price">R$ 14,90</span>
                <span id="price-period">/mês</span>
            </div>
            
            <div class="quantity-controls">
                <button class="quantity-btn" id="decrease-btn">-</button>
                <input type="number" id="quantity" min="1" max="100" value="1">
                <button class="quantity-btn" id="increase-btn">+</button>
            </div>
            
            <div class="discount-info" id="discount-info"></div>
            
            <div class="total">
                <p><strong>Total:</strong> <span id="total-price">R$ 14,90</span></p>
            </div>
        </div>
        
        <button id="checkout-btn" class="checkout-btn">Finalizar Compra</button>
        <div id="error-container" class="error-message"></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Constantes e variáveis
            const MONTHLY_PRICE = 14.90;
            const YEARLY_DISCOUNT = 2; // 2 meses grátis no plano anual
            const DEFAULT_QUANTITY = 1;
            
            // Elementos do DOM
            const planButtons = document.querySelectorAll('.plan-type-btn');
            const quantityInput = document.getElementById('quantity');
            const decreaseBtn = document.getElementById('decrease-btn');
            const increaseBtn = document.getElementById('increase-btn');
            const unitPriceElement = document.getElementById('unit-price');
            const pricePeriodElement = document.getElementById('price-period');
            const totalPriceElement = document.getElementById('total-price');
            const discountInfoElement = document.getElementById('discount-info');
            const checkoutBtn = document.getElementById('checkout-btn');
            const errorContainer = document.getElementById('error-container');
            
            // Estado inicial
            let currentPlan = 'monthly';
            let quantity = DEFAULT_QUANTITY;
            
            // Atualizar exibição de preço unitário
            function updateUnitPrice() {
                if (currentPlan === 'monthly') {
                    unitPriceElement.textContent = `R$ ${MONTHLY_PRICE.toFixed(2).replace('.', ',')}`;
                    pricePeriodElement.textContent = '/mês';
                } else {
                    const yearlyPrice = MONTHLY_PRICE * (12 - YEARLY_DISCOUNT);
                    unitPriceElement.textContent = `R$ ${yearlyPrice.toFixed(2).replace('.', ',')}`;
                    pricePeriodElement.textContent = '/ano';
                }
            }
            
            // Calcular e atualizar o preço total
            function updateTotalPrice() {
                let totalPrice;
                let discountInfo = '';
                
                if (currentPlan === 'monthly') {
                    totalPrice = MONTHLY_PRICE * quantity;
                    
                    // Aplicar descontos por volume em planos mensais
                    if (quantity >= 10) {
                        const discount = 0.1; // 10% de desconto
                        const discountAmount = totalPrice * discount;
                        totalPrice -= discountAmount;
                        discountInfo = `Desconto de 10% aplicado!`;
                    } else if (quantity >= 5) {
                        const discount = 0.05; // 5% de desconto
                        const discountAmount = totalPrice * discount;
                        totalPrice -= discountAmount;
                        discountInfo = `Desconto de 5% aplicado!`;
                    }
                } else {
                    // Plano anual (12 meses - 2 meses grátis)
                    const monthsToCharge = 12 - YEARLY_DISCOUNT;
                    totalPrice = MONTHLY_PRICE * monthsToCharge * quantity;
                    discountInfo = `${YEARLY_DISCOUNT} meses grátis incluídos!`;
                }
                
                // Atualizar exibição
                totalPriceElement.textContent = `R$ ${totalPrice.toFixed(2).replace('.', ',')}`;
                discountInfoElement.textContent = discountInfo;
                
                return totalPrice;
            }
            
            // Alternar entre planos
            planButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const plan = btn.getAttribute('data-plan');
                    
                    // Atualizar botões
                    planButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Atualizar tipo de plano
                    currentPlan = plan;
                    
                    // Atualizar exibição de preço
                    updateUnitPrice();
                    updateTotalPrice();
                });
            });
            
            // Controles de quantidade
            decreaseBtn.addEventListener('click', () => {
                if (quantity > 1) {
                    quantity--;
                    quantityInput.value = quantity;
                    updateTotalPrice();
                }
            });
            
            increaseBtn.addEventListener('click', () => {
                if (quantity < 100) {
                    quantity++;
                    quantityInput.value = quantity;
                    updateTotalPrice();
                }
            });
            
            quantityInput.addEventListener('input', () => {
                const newValue = parseInt(quantityInput.value) || 0;
                if (newValue >= 1 && newValue <= 100) {
                    quantity = newValue;
                } else if (newValue < 1) {
                    quantity = 1;
                    quantityInput.value = 1;
                } else if (newValue > 100) {
                    quantity = 100;
                    quantityInput.value = 100;
                }
                updateTotalPrice();
            });
            
            // Processar checkout
            checkoutBtn.addEventListener('click', async () => {
                try {
                    // Desabilitar botão durante o processamento
                    checkoutBtn.disabled = true;
                    checkoutBtn.textContent = 'Processando...';
                    errorContainer.textContent = '';
                    
                    // Calcular preço total atual
                    const totalPrice = updateTotalPrice();
                    
                    // Obter chave pública do Stripe
                    const stripeResponse = await fetch('http://localhost:8080/stripe-key');
                    if (!stripeResponse.ok) {
                        throw new Error('Erro ao obter configurações de pagamento');
                    }
                    
                    const { publishableKey } = await stripeResponse.json();
                    const stripe = Stripe(publishableKey);
                    
                    // Criar sessão de checkout
                    const checkoutData = {
                        quantity: quantity,
                        planType: currentPlan
                    };
                    
                    const response = await fetch('http://localhost:8080/create-checkout-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(checkoutData),
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Erro ao criar sessão de pagamento');
                    }
                    
                    const { url } = await response.json();
                    
                    // Redirecionar para a página de checkout do Stripe
                    window.location.href = url;
                    
                } catch (error) {
                    console.error('Erro:', error);
                    errorContainer.textContent = error.message || 'Erro ao processar pagamento. Tente novamente.';
                    
                    // Restaurar o botão
                    checkoutBtn.disabled = false;
                    checkoutBtn.textContent = 'Finalizar Compra';
                }
            });
            
            // Inicializar
            updateUnitPrice();
            updateTotalPrice();
        });
    </script>
</body>
</html> 